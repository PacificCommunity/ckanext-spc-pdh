ckan.module("clonable-fieldset",function(i,e){"use strict";return{options:{multiple:!0,wildcard:null,i:0,buttonTpl:'<button type="button" class="btn btn-success btn-add-fieldset"><i class="fa fa-plus"/> Add</button>',wildcardedProps:["id","data-target","name","for","onclick"]},initialize:function(){i.proxyAll(this,/_on/),this._addButton=i(this.options.buttonTpl),this._addButton.on("click",this._onAddClick),this.el.after(this._addButton),ckan.pubsub.subscribe("clonable-fieldset",this._onSubscription),this.updateAvailability()},updateAvailability:function(){!this.options.multiple&&this.el.siblings("fieldset").length?this._addButton.prop("disabled",!0):this._addButton.prop("disabled",!1)},_onSubscription:function(e,t){var n;if("remove"===e){if(n=document.getElementById(t),console.log(arguments,n,t),!n)return;n.remove()}this.updateAvailability()},_onAddClick:function(){this.el.find(".select2-container").remove(),this.el.find(".select2-offscreen").removeClass("select2-offscreen");var e=this.el.clone();e.find(".btn-add-fieldset").remove();var t=this.options.wildcardedProps,n=this.options.wildcard,a=this.options.i;e.prop("disabled",!1).attr("data-module",null);for(var o=0;o<t.length;o++)e.attr(t[o])&&e.attr(t[o],e.attr(t[o]).replace(n,a)),i("["+t[o]+'*="'+n+'"]',e).each(function(){i(this).attr(t[o],i(this).attr(t[o]).replace(n,a))});++this.options.i,this.el.before(e),e.show(400),e.find("[data-module]").each(function(){ckan.module.initializeElement(this)}),e.find(".select2-container").remove(),e.find('[data-module="autocomplete"]').each(function(){ckan.module.initializeElement(this)}),this.updateAvailability()}}}),ckan.module("friendly-coords",function(o,e){"use strict";return{initialize:function(){o.proxyAll(this,/_on/);var e="#"+this.el.prop("name");this._s=o(e+"-s").on("change.friendly-coord",this._onOneCoordChanged),this._w=o(e+"-w").on("change.friendly-coord",this._onOneCoordChanged),this._n=o(e+"-n").on("change.friendly-coord",this._onOneCoordChanged),this._e=o(e+"-e").on("change.friendly-coord",this._onOneCoordChanged),ckan.pubsub.subscribe("inner_layer_change",this._onMapChanged)},_onOneCoordChanged:function(e){var t=[this._convertStrToFloat(this._s.val()),this._convertStrToFloat(this._w.val()),this._convertStrToFloat(this._n.val()),this._convertStrToFloat(this._e.val())];if(!t.some(isNaN)){var n=o(":invalid").filter("[id^=spatial_coverage-]"),a=o(":valid").filter("[id^=spatial_coverage-]");if(t[0]===t[2]?(n=n.add(this._n).add(this._s)).tooltip({title:"North and South boundaries can't match. Line and point extents are not supported."}):this._n.add(this._s).tooltip("destroy"),t[1]===t[3]?(n=n.add(this._e).add(this._w)).tooltip({title:"East and West boundaries can't match. Line and point extents are not supported."}):this._e.add(this._w).tooltip("destroy"),a.closest(".control-group").removeClass("error"),n.length)return o("[type=submit]").prop("disabled",!0),void n.closest(".control-group").addClass("error");o("[type=submit]").prop("disabled",!1),ckan.pubsub.publish("outer_layer_change",t)}},_onMapChanged:function(e){var t=e.getBounds().toBBoxString().split(",");this._w.val(this._convertStrToFloat(t[0])),this._s.val(this._convertStrToFloat(t[1])),this._e.val(this._convertStrToFloat(t[2])),this._n.val(this._convertStrToFloat(t[3]))},_convertStrToFloat:function(e){return parseFloat(e).toFixed(5)}}}),function(a){function s(e){return e instanceof Object&&0<Object.keys(e).length}function c(e,t,n){if(html="","string"==typeof e)!function(e){return/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(e)}(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))?html+='<span class="json-string">'+e+"</span>":html+='<a href="'+e+'" class="json-string">'+e+"</a>";else if("number"==typeof e)html+='<span class="json-literal">'+e+"</span>";else if("boolean"==typeof e)html+='<span class="json-literal">'+e+"</span>";else if(null===e)html+='<span class="json-literal"></span>';else if(e instanceof Array){if(0<e.length){html+='<ol class="json-array">';for(var a=0;a<e.length;++a){html+="<li>";var o=t.withQuotes?'<span class="json-string">"'+a+'1"</span>':a+1;!n&&1<e.length&&s(e[a])?html+='<a href class="json-toggle">'+o+"</a>":html+=o,html+=": "+c(e[a],t,!1),html+="</li>"}html+="</ol>"}}else if("object"==typeof e){if(0<Object.keys(e).length){for(var i in html+='<ul class="json-dict">',e)if(e.hasOwnProperty(i)){html+="<li>";var r="string"==typeof(l=i.replace(/_/g," "))?l.charAt(0).toUpperCase()+l.slice(1):l;o=t.withQuotes?'<span class="json-string">"'+r+'"</span>':r;s(e[i])?html+='<a href class="json-toggle">'+o+"</a>":html+=o,html+=": "+c(e[i],t,!1),html+="</li>"}html+="</ul>"}}var l;return html}a.fn.jsonBrowse=function(t,n){return n=n||{},this.each(function(){var e=c(t,n,!0);a(this).html(e),a(this).off("click"),a(this).on("click","a.json-toggle",function(){var e=a(this).toggleClass("collapsed").siblings("ul.json-dict, ol.json-array");if(e.toggle(),e.is(":visible"))e.siblings(".json-placeholder").remove();else{var t=e.children("li").length,n=t+(1<t?" items":" item");e.after('<a href class="json-placeholder">'+n+"</a>")}return!1}),a(this).on("click","a.json-placeholder",function(){return a(this).siblings("a.json-toggle").click(),!1}),1==n.collapsed&&a(this).find("a.json-toggle").click()})}}(jQuery),function(e){"function"==typeof define&&define.amd&&define.amd.jQuery?define(["jquery"],e):e("undefined"!=typeof module&&module.exports?require("jquery"):jQuery)}(function(le){"use strict";function a(e,l){function t(e){if(!(!0===V.data(Be+"_intouch")||0<le(e.target).closest(l.excludedElements,V).length)){var t=e.originalEvent?e.originalEvent:e;if(!t.pointerType||"mouse"!=t.pointerType||0!=l.fallbackToMouseEvents){var n,a=t.touches,o=a?a[0]:t;return Z=Se,a?K=a.length:!1!==l.preventDefaultEvents&&e.preventDefault(),Y=q=U=null,H=1,W=Q=z=G=J=0,X=function(){var e={};return e[se]=L(se),e[ce]=L(ce),e[ue]=L(ue),e[de]=L(de),e}(),x(),k(0,o),!a||K===l.fingers||l.fingers===xe||g()?(ee=A(),2==K&&(k(1,a[1]),z=Q=F($[0].start,$[1].start)),(l.swipeStatus||l.pinchStatus)&&(n=c(t,Z))):n=!1,!1===n?(c(t,Z=Oe),n):(l.hold&&(re=setTimeout(le.proxy(function(){V.trigger("hold",[t.target]),l.hold&&(n=l.hold.call(V,t,t.target))},this),l.longTapThreshold)),S(!0),null)}}}function n(e){var t=e.originalEvent?e.originalEvent:e;if(Z!==Ee&&Z!==Oe&&!C()){var n,a=t.touches,o=E(a?a[0]:t);if(te=A(),a&&(K=a.length),l.hold&&clearTimeout(re),Z=ke,2==K&&(0==z?(k(1,a[1]),z=Q=F($[0].start,$[1].start)):(E(a[1]),Q=F($[0].end,$[1].end),$[0].end,$[1].end,Y=H<1?he:pe),H=function(e,t){return(t/e*1).toFixed(2)}(z,Q),W=Math.abs(z-Q)),K===l.fingers||l.fingers===xe||!a||g()){if(U=B(o.start,o.end),function(e,t){if(!1!==l.preventDefaultEvents)if(l.allowPageScroll===fe)e.preventDefault();else{var n=l.allowPageScroll===ge;switch(t){case se:(l.swipeLeft&&n||!n&&l.allowPageScroll!=_e)&&e.preventDefault();break;case ce:(l.swipeRight&&n||!n&&l.allowPageScroll!=_e)&&e.preventDefault();break;case ue:(l.swipeUp&&n||!n&&l.allowPageScroll!=Te)&&e.preventDefault();break;case de:(l.swipeDown&&n||!n&&l.allowPageScroll!=Te)&&e.preventDefault()}}}(e,q=B(o.last,o.end)),J=function(e,t){return Math.round(Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)))}(o.start,o.end),G=j(),function(e,t){e!=fe&&(t=Math.max(t,O(e)),X[e].distance=t)}(U,J),n=c(t,Z),!l.triggerOnTouchEnd||l.triggerOnTouchLeave){var i=!0;if(l.triggerOnTouchLeave){var r=function(e){var t=(e=le(e)).offset();return{left:t.left,right:t.left+e.outerWidth(),top:t.top,bottom:t.top+e.outerHeight()}}(this);i=function(e,t){return e.x>t.left&&e.x<t.right&&e.y>t.top&&e.y<t.bottom}(o.end,r)}!l.triggerOnTouchEnd&&i?Z=s(ke):l.triggerOnTouchLeave&&!i&&(Z=s(Ee)),Z!=Oe&&Z!=Ee||c(t,Z)}}else c(t,Z=Oe);!1===n&&c(t,Z=Oe)}}function a(e){var t=e.originalEvent?e.originalEvent:e,n=t.touches;if(n){if(n.length&&!C())return function(e){ne=A(),ae=e.touches.length+1}(t),!0;if(n.length&&C())return!0}return C()&&(K=ae),te=A(),G=j(),p()||!d()?c(t,Z=Oe):l.triggerOnTouchEnd||!1===l.triggerOnTouchEnd&&Z===ke?(!1!==l.preventDefaultEvents&&!1!==e.cancelable&&e.preventDefault(),c(t,Z=Ee)):!l.triggerOnTouchEnd&&w()?u(t,Z=Ee,ye):Z===ke&&c(t,Z=Oe),S(!1),null}function o(){Q=z=ee=te=K=0,H=1,x(),S(!1)}function i(e){var t=e.originalEvent?e.originalEvent:e;l.triggerOnTouchLeave&&c(t,Z=s(Ee))}function r(){V.unbind(P,t),V.unbind(I,o),V.unbind(M,n),V.unbind(D,a),R&&V.unbind(R,i),S(!1)}function s(e){var t=e,n=h(),a=d(),o=p();return!n||o?t=Oe:!a||e!=ke||l.triggerOnTouchEnd&&!l.triggerOnTouchLeave?!a&&e==Ee&&l.triggerOnTouchLeave&&(t=Oe):t=Ee,t}function c(e,t){var n,a=e.touches;return(!m()||!v())&&!v()||(n=u(e,t,me)),(!f()||!g())&&!g()||!1===n||(n=u(e,t,ve)),T()&&_()&&!1!==n?n=u(e,t,be):G>l.longTapThreshold&&J<Ce&&l.longTap&&!1!==n?n=u(e,t,we):1!==K&&Le||!(isNaN(J)||J<l.threshold)||!w()||!1===n||(n=u(e,t,ye)),t===Oe&&o(),t===Ee&&(a&&a.length||o()),n}function u(e,t,n){var a;if(n==me){if(V.trigger("swipeStatus",[t,U||null,J||0,G||0,K,$,q]),l.swipeStatus&&!1===(a=l.swipeStatus.call(V,e,t,U||null,J||0,G||0,K,$,q)))return!1;if(t==Ee&&m()){if(clearTimeout(ie),clearTimeout(re),V.trigger("swipe",[U,J,G,K,$,q]),l.swipe&&!1===(a=l.swipe.call(V,e,U,J,G,K,$,q)))return!1;switch(U){case se:V.trigger("swipeLeft",[U,J,G,K,$,q]),l.swipeLeft&&(a=l.swipeLeft.call(V,e,U,J,G,K,$,q));break;case ce:V.trigger("swipeRight",[U,J,G,K,$,q]),l.swipeRight&&(a=l.swipeRight.call(V,e,U,J,G,K,$,q));break;case ue:V.trigger("swipeUp",[U,J,G,K,$,q]),l.swipeUp&&(a=l.swipeUp.call(V,e,U,J,G,K,$,q));break;case de:V.trigger("swipeDown",[U,J,G,K,$,q]),l.swipeDown&&(a=l.swipeDown.call(V,e,U,J,G,K,$,q))}}}if(n==ve){if(V.trigger("pinchStatus",[t,Y||null,W||0,G||0,K,H,$]),l.pinchStatus&&!1===(a=l.pinchStatus.call(V,e,t,Y||null,W||0,G||0,K,H,$)))return!1;if(t==Ee&&f())switch(Y){case pe:V.trigger("pinchIn",[Y||null,W||0,G||0,K,H,$]),l.pinchIn&&(a=l.pinchIn.call(V,e,Y||null,W||0,G||0,K,H,$));break;case he:V.trigger("pinchOut",[Y||null,W||0,G||0,K,H,$]),l.pinchOut&&(a=l.pinchOut.call(V,e,Y||null,W||0,G||0,K,H,$))}}return n==ye?t!==Oe&&t!==Ee||(clearTimeout(ie),clearTimeout(re),_()&&!T()?(oe=A(),ie=setTimeout(le.proxy(function(){oe=null,V.trigger("tap",[e.target]),l.tap&&(a=l.tap.call(V,e,e.target))},this),l.doubleTapThreshold)):(oe=null,V.trigger("tap",[e.target]),l.tap&&(a=l.tap.call(V,e,e.target)))):n==be?t!==Oe&&t!==Ee||(clearTimeout(ie),clearTimeout(re),oe=null,V.trigger("doubletap",[e.target]),l.doubleTap&&(a=l.doubleTap.call(V,e,e.target))):n==we&&(t!==Oe&&t!==Ee||(clearTimeout(ie),oe=null,V.trigger("longtap",[e.target]),l.longTap&&(a=l.longTap.call(V,e,e.target)))),a}function d(){var e=!0;return null!==l.threshold&&(e=J>=l.threshold),e}function p(){var e=!1;return null!==l.cancelThreshold&&null!==U&&(e=O(U)-J>=l.cancelThreshold),e}function h(){return!(l.maxTimeThreshold&&G>=l.maxTimeThreshold)}function f(){var e=y(),t=b(),n=null===l.pinchThreshold||W>=l.pinchThreshold;return e&&t&&n}function g(){return!!(l.pinchStatus||l.pinchIn||l.pinchOut)}function m(){var e=h(),t=d(),n=y(),a=b();return!p()&&a&&n&&t&&e}function v(){return!!(l.swipe||l.swipeStatus||l.swipeLeft||l.swipeRight||l.swipeUp||l.swipeDown)}function y(){return K===l.fingers||l.fingers===xe||!Le}function b(){return 0!==$[0].end.x}function w(){return!!l.tap}function _(){return!!l.doubleTap}function T(){if(null==oe)return!1;var e=A();return _()&&e-oe<=l.doubleTapThreshold}function x(){ae=ne=0}function C(){var e=!1;ne&&A()-ne<=l.fingerReleaseThreshold&&(e=!0);return e}function S(e){V&&(!0===e?(V.bind(M,n),V.bind(D,a),R&&V.bind(R,i)):(V.unbind(M,n,!1),V.unbind(D,a,!1),R&&V.unbind(R,i,!1)),V.data(Be+"_intouch",!0===e))}function k(e,t){var n={start:{x:0,y:0},last:{x:0,y:0},end:{x:0,y:0}};return n.start.x=n.last.x=n.end.x=t.pageX||t.clientX,n.start.y=n.last.y=n.end.y=t.pageY||t.clientY,$[e]=n}function E(e){var t=void 0!==e.identifier?e.identifier:0,n=function(e){return $[e]||null}(t);return null===n&&(n=k(t,e)),n.last.x=n.end.x,n.last.y=n.end.y,n.end.x=e.pageX||e.clientX,n.end.y=e.pageY||e.clientY,n}function O(e){if(X[e])return X[e].distance}function L(e){return{direction:e,distance:0}}function j(){return te-ee}function F(e,t){var n=Math.abs(e.x-t.x),a=Math.abs(e.y-t.y);return Math.round(Math.sqrt(n*n+a*a))}function B(e,t){if(function(e,t){return e.x==t.x&&e.y==t.y}(e,t))return fe;var n=function(e,t){var n=e.x-t.x,a=t.y-e.y,o=Math.atan2(a,n),i=Math.round(180*o/Math.PI);return i<0&&(i=360-Math.abs(i)),i}(e,t);return n<=45&&0<=n?se:n<=360&&315<=n?se:135<=n&&n<=225?ce:45<n&&n<135?de:ue}function A(){return(new Date).getTime()}l=le.extend({},l);var N=Le||Fe||!l.fallbackToMouseEvents,P=N?Fe?je?"MSPointerDown":"pointerdown":"touchstart":"mousedown",M=N?Fe?je?"MSPointerMove":"pointermove":"touchmove":"mousemove",D=N?Fe?je?"MSPointerUp":"pointerup":"touchend":"mouseup",R=N?Fe?"mouseleave":null:"mouseleave",I=Fe?je?"MSPointerCancel":"pointercancel":"touchcancel",J=0,U=null,q=null,G=0,z=0,Q=0,H=1,W=0,Y=0,X=null,V=le(e),Z="start",K=0,$={},ee=0,te=0,ne=0,ae=0,oe=0,ie=null,re=null;try{V.bind(P,t),V.bind(I,o)}catch(e){le.error("events not supported "+P+","+I+" on jQuery.swipe")}this.enable=function(){return this.disable(),V.bind(P,t),V.bind(I,o),V},this.disable=function(){return r(),V},this.destroy=function(){r(),V.data(Be,null),V=null},this.option=function(e,t){if("object"==typeof e)l=le.extend(l,e);else if(void 0!==l[e]){if(void 0===t)return l[e];l[e]=t}else{if(!e)return l;le.error("Option "+e+" does not exist on jQuery.swipe.options")}return null}}var se="left",ce="right",ue="up",de="down",pe="in",he="out",fe="none",ge="auto",me="swipe",ve="pinch",ye="tap",be="doubletap",we="longtap",_e="horizontal",Te="vertical",xe="all",Ce=10,Se="start",ke="move",Ee="end",Oe="cancel",Le="ontouchstart"in window,je=window.navigator.msPointerEnabled&&!window.navigator.pointerEnabled&&!Le,Fe=(window.navigator.pointerEnabled||window.navigator.msPointerEnabled)&&!Le,Be="TouchSwipe";le.fn.swipe=function(e){var t=le(this),n=t.data(Be);if(n&&"string"==typeof e){if(n[e])return n[e].apply(n,Array.prototype.slice.call(arguments,1));le.error("Method "+e+" does not exist on jQuery.swipe")}else if(n&&"object"==typeof e)n.option.apply(n,arguments);else if(!(n||"object"!=typeof e&&e))return function(n){return!n||void 0!==n.allowPageScroll||void 0===n.swipe&&void 0===n.swipeStatus||(n.allowPageScroll=fe),void 0!==n.click&&void 0===n.tap&&(n.tap=n.click),n=n||{},n=le.extend({},le.fn.swipe.defaults,n),this.each(function(){var e=le(this),t=e.data(Be);t||(t=new a(this,n),e.data(Be,t))})}.apply(this,arguments);return t},le.fn.swipe.version="1.6.18",le.fn.swipe.defaults={fingers:1,threshold:75,cancelThreshold:null,pinchThreshold:20,maxTimeThreshold:null,fingerReleaseThreshold:250,longTapThreshold:500,doubleTapThreshold:200,swipe:null,swipeLeft:null,swipeRight:null,swipeUp:null,swipeDown:null,swipeStatus:null,pinchIn:null,pinchOut:null,pinchStatus:null,click:null,tap:null,doubleTap:null,longTap:null,hold:null,triggerOnTouchEnd:!0,triggerOnTouchLeave:!1,allowPageScroll:"auto",fallbackToMouseEvents:!0,excludedElements:".noSwipe",preventDefaultEvents:!0},le.fn.swipe.phases={PHASE_START:Se,PHASE_MOVE:ke,PHASE_END:Ee,PHASE_CANCEL:Oe},le.fn.swipe.directions={LEFT:se,RIGHT:ce,UP:ue,DOWN:de,IN:pe,OUT:he},le.fn.swipe.pageScroll={NONE:fe,HORIZONTAL:_e,VERTICAL:Te,AUTO:ge},le.fn.swipe.fingers={ONE:1,TWO:2,THREE:3,FOUR:4,FIVE:5,ALL:xe}}),function(n){n("body").append('<div class="ma5-mobile-menu-container"/>'),n(".ma5-menu-mobile").find("ul").clone().addClass("ma5-menu-panel").appendTo(".ma5-mobile-menu-container").find("ul").remove(),n(".ma5-toggle-menu").on("click touch",function(){n("html").toggleClass("ma5-menu-active")}),n(".ma5-btn-enter").on("click touch",function(){n(".ma5-menu-panel").removeClass("ma5-active-ul"),n(".ma5-menu-panel li").removeClass("ma5-active-li");var e=n(this).parent().attr("class").replace("li","ul"),t=((t=n(this).parent().attr("class").replace("li","ul").split("-")).splice(-1,1),t.join("-"));n(".ma5-menu-panel").removeClass("ma5-active-leave ma5-parent-leave ma5-active-enter ma5-parent-enter"),n(".ma5-menu-panel."+t).addClass("ma5-parent-enter"),n(".ma5-menu-panel."+e).addClass("ma5-active-enter")}),n(".ma5-leave-bar").on("click touch",function(){(e=n(this).next().attr("class").replace("li","ul").split("-")).splice(-1,1),e.splice(-1,1);var e=e.join("-"),t=((t=n(this).next().attr("class").replace("li","ul").split("-")).splice(-1,1),t.join("-"));n(".ma5-menu-panel").removeClass("ma5-active-leave ma5-parent-leave ma5-active-enter ma5-parent-enter"),n(".ma5-menu-panel."+e).addClass("ma5-parent-leave"),n(".ma5-menu-panel."+t).addClass("ma5-active-leave")})}(jQuery),function(n){n(".json-data").map(function(e,t){n(t).jsonBrowse(n(t).data().json,{collapsed:!0})})}(jQuery),function(e){function n(e,t){var n=document.createElement("a");n.href=e;var a=document.createElement("i");return a.classList.add("fa"),a.classList.add(t),n.appendChild(a),n.addEventListener("click",function(e){e.preventDefault(),window.open(n.href,"shareWindow","height=450, width=550, toolbar=0, menubar=0, top=200")}),n}function a(){return encodeURIComponent(window.location.href)}function o(){return encodeURIComponent(document.head.querySelector("title").textContent)}var t=[function(e){var t="https://www.facebook.com/share.php?u="+a();return e.appendChild(n(t,"fa-facebook")),e},function(e){var t="https://twitter.com/share?text="+o()+"&url="+a();return e.appendChild(n(t,"fa-twitter")),e},function(e){var t="https://www.linkedin.com/shareArticle?mini=true&title="+o()+"&summary=&url="+a();return e.appendChild(n(t,"fa-linkedin")),e},function(e){var t="mailto:?subject="+o()+"&body=You might want to check this out: "+a();return e.appendChild(n(t,"fa-envelope")),e}];e(document).ready(function(){var n=document.createElement("ul");n.classList.add("social-share--panel"),t.forEach(function(e){var t=document.createElement("li");t.classList.add("social-share--tile"),n.appendChild(e(t))}),document.body.appendChild(n)})}(jQuery),this.ckan.module("spatial-select",function(s,e){return{options:{i18n:{},style:{color:"#F06F64",weight:2,opacity:1,fillColor:"#F06F64",fillOpacity:.1,clickable:!1},default_extent:[[90,180],[-90,-180]]},initialize:function(){s.proxyAll(this,/_on/);var e=this.el.data("default_extent");e&&(e instanceof Array?this.options.default_extent=e:e instanceof Object&&(this.options.default_extent=new L.GeoJSON(e).getBounds())),this.el.ready(this._onReady)},_drawExtentFromCoords:function(e,t,n,a){if(s.isArray(e)){var o=e;e=o[0],t=o[1],n=o[2],a=o[3]}return new L.Rectangle([[t,e],[a,n]],this.options.style)},_drawExtentFromGeoJSON:function(e){return new L.GeoJSON(e,{style:this.options.style})},flattenToCoordinates:function(e){for(var t=e.features,n=[],a=0;a<t.length;a++)t[a].geometry.coordinates?n.push(t[a].geometry.coordinates):t[a].geometry.features.forEach(function(e){t.push(e)});return n},_onReady:function(){var o,i=this,r=s("#field-spatial");r.on("input",function(e){e.target.value=e.target.value.split("\n").join("");try{s("#formatted-spatial").text(JSON.stringify(JSON.parse(e.target.value),null,2)),t()}catch(e){}}),r.trigger("input"),s("#predefined_areas").on("change",function(e){var o=e.val;"all"===o&&(o={type:"MultiPolygon",coordinates:[]},Array.prototype.slice.apply(e.target.options,[0]).forEach(function(e){var t=e.value;if(t&&"all"!==t){var n=JSON.parse(t),a="MultiPolygon"===n.type?n.coordinates:[n.coordinates];o.coordinates=o.coordinates.concat(a)}}),o=JSON.stringify(o)),r.val(o).trigger("input")}),o=ckan.commonLeafletMap("dataset-map-container",i.options.map_config,{attributionControl:!1,drawControlTooltips:!1}),L.drawLocal.edit.toolbar.buttons.remove="Delete last layer.";var l=new L.FeatureGroup;function n(){var e=i.flattenToCoordinates(l.toGeoJSON());r.val(e.length?JSON.stringify({type:1<e.length?"MultiPolygon":"Polygon",coordinates:1<e.length?e:e[0]}):""),r.trigger("input")}function a(){var e=l.getLayers().shift();e&&l.removeLayer(e)}function t(){var e=r.val();if(e){try{new L.GeoJSON(JSON.parse(e))}catch(e){return void r.closest(".control-group").addClass("error")}r.closest(".control-group").removeClass("error"),l.clearLayers();var t,n=JSON.parse(e);if("MultiPolygon"===n.type)for(var a=0;a<n.coordinates.length;a++)coord=n.coordinates[a],t=i._drawExtentFromGeoJSON({type:"Polygon",coordinates:coord}),l.addLayer(t);else t=i._drawExtentFromGeoJSON(n),l.addLayer(t);o.fitBounds(t.getBounds()),ckan.pubsub.publish("inner_layer_change",t)}}o.addLayer(l),o.addControl(new L.Control.Draw({position:"topright",draw:{undo:!0,polyline:!1,polygon:{shapeOptions:i.options.style,allowIntersection:!1},circle:!1,marker:!1,rectangle:{shapeOptions:i.options.style}},edit:{featureGroup:l,edit:!1,remove:!0}})),o.on("draw:created",function(e){var t=e.layer;ckan.pubsub.publish("inner_layer_change",t),l.addLayer(t),L.Util.requestAnimFrame(o.invalidateSize,o,!1,o._container),requestAnimationFrame(function(){o.fitBounds(t.getBounds()),n()})}),s(".leaflet-draw-edit-remove").on("click",function(){a(),n();var e=l.getLayers().shift();e&&(o.fitBounds(e.getBounds()),ckan.pubsub.publish("inner_layer_change",e))}),ckan.pubsub.subscribe("outer_layer_change",function(e){!function(e){a();var t=i._drawExtentFromCoords(e);l.addLayer(t),o.fitBounds(t.getBounds()),n()}([e[1],e[0],e[3],e[2]])}),o.fitBounds(i.options.default_extent),t()}}}),ckan.module("spc-sortable-facets",function(o,e){"use strict";return{options:{selector:".nav-facet .nav-item"},initialize:function(){this._enumerateFacets(this._findFacets()),this.el.on("click",this._onHeadingClick.bind(this))},_findFacets:function(){return this.el.parent().find(this.options.selector)},_enumerateFacets:function(e){e.each(function(e,t){t.style.order=e})},_onHeadingClick:function(e){var t=o(e.target);t.is("i")&&(t=t.parent());var n=t.data("sortType");if(n){this.el.find(".facet-sorter").not(t).removeClass("active reverse"),t.hasClass("active")?t.toggleClass("reverse"):t.addClass("active");var a=t.hasClass("reverse");this._rearrangeFacets(this._findFacets(),this._comparators[n],a)}},_rearrangeFacets:function(e,n,a){e.parent();a=a||!1,e.sort(function(e,t){return n(e,t)*(a?-1:1)}).each(function(e,t){t.style.order=e})},_comparators:{"data-name":function(e,t){return e.dataset.name.localeCompare(t.dataset.name)},"data-number":function(e,t){return e.dataset.number-t.dataset.number}}}}),this.ckan.module("spc-spatial-query",function(p,e){return{options:{i18n:{},style:{color:"#F06F64",weight:2,opacity:1,fillColor:"#F06F64",fillOpacity:.1,clickable:!1},default_extent:[[90,180],[-90,-180]]},template:{buttons:['<div id="dataset-map-edit-buttons">','<a href="javascript:;" class="btn cancel">Cancel</a> ','<a href="javascript:;" class="btn apply disabled">Apply</a>',"</div>"].join("")},initialize:function(){p.proxyAll(this,/_on/);var e=this.el.data("default_extent");e&&(e instanceof Array?this.options.default_extent=e:e instanceof Object&&(this.options.default_extent=new L.GeoJSON(e).getBounds())),this.el.ready(this._onReady),p(".show-filters").on("click",function(){ckan.pubsub.publish("spatial_query_center_map"),setTimeout(function(){ckan.pubsub.publish("spatial_query_center_map")},0)})},_getParameterByName:function(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t?decodeURIComponent(t[1].replace(/\+/g," ")):null},_drawExtentFromCoords:function(e,t,n,a){if(p.isArray(e)){var o=e;e=o[0],t=o[1],n=o[2],a=o[3]}return new L.Rectangle([[t,e],[a,n]],this.options.style)},_drawExtentFromGeoJSON:function(e){return new L.GeoJSON(e,{style:this.options.style})},_onReady:function(){var t,n,e,a,o,i=this,r=!1,l=!0,s=p("#dataset-search");function c(){(o=i._getParameterByName("ext_bbox"))&&(p("#ext_bbox").val(o),n=i._drawExtentFromCoords(o.split(",")),t.addLayer(n),t.fitBounds(n.getBounds()))}function u(){(e=i._getParameterByName("ext_prev_extent"))?(coords=e.split(","),t.fitBounds([[coords[1],coords[0]],[coords[3],coords[2]]])):o||t.fitBounds(i.options.default_extent)}function d(){L.Util.requestAnimFrame(t.invalidateSize,t,!1,t._container)}s.length||(s=p(".search-form")),p(["ext_bbox","ext_prev_extent"]).each(function(e,t){0===p("#"+t).length&&p('<input type="hidden" />').attr({id:t,name:t}).appendTo(s)}),(t=ckan.commonLeafletMap("dataset-map-container",this.options.map_config,{attributionControl:!1,drawControlTooltips:!1})).addControl(new L.Control.Draw({position:"topright",draw:{polyline:!1,polygon:!1,circle:!1,marker:!1,rectangle:{shapeOptions:i.options.style}}})),p("a.leaflet-draw-draw-rectangle",i.el).on("click",function(e){r||(p("body").addClass("dataset-map-expanded"),l&&!n&&t.zoomIn(),d(),r=!0)}),a=p(i.template.buttons).insertBefore("#dataset-map-attribution"),p(".cancel",a).on("click",function(){p("body").removeClass("dataset-map-expanded"),n&&t.removeLayer(n),u(),c(),d(),r=!1}),p(".apply",a).on("click",function(){n&&(p("body").removeClass("dataset-map-expanded"),r=!1,d(),setTimeout(function(){t.fitBounds(n.getBounds()),setTimeout(function(){s.submit()},800)},200))}),t.on("draw:created",function(e){n&&t.removeLayer(n),n=e.layer,p("#ext_bbox").val(n.getBounds().toBBoxString()),t.addLayer(n),p(".apply",a).removeClass("disabled").addClass("btn-primary"),p(".apply:visible",a).length||p(".apply",a).trigger("click")}),t.on("moveend",function(e){p("#ext_prev_extent").val(t.getBounds().toBBoxString())}),c(),u(),t.on("zoomstart",function(e){l=!1}),ckan.pubsub.subscribe("spatial_query_center_map",function(){d(),u()})}}});